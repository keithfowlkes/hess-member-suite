<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Refresh Analytics Datacube</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
    }
    button:hover {
      background: #1d4ed8;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 5px;
      display: none;
    }
    .success {
      background: #d1fae5;
      color: #065f46;
    }
    .error {
      background: #fee2e2;
      color: #991b1b;
    }
    .loading {
      background: #dbeafe;
      color: #1e40af;
    }
    .info {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Refresh Analytics Datacube</h1>
    
    <div class="info">
      <strong>What does this do?</strong>
      <p style="margin: 10px 0 0 0;">
        This refreshes the analytics datacube with the latest count of active member organizations. 
        The datacube automatically updates hourly and whenever organizations change, but you can use this button for an immediate refresh.
      </p>
    </div>

    <button id="refreshBtn" onclick="refreshDatacube()">Refresh Now</button>
    
    <div id="result"></div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://tyovnvuluyosjnabrzjc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5b3ZudnVsdXlvc2puYWJyempjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyMjE0MzIsImV4cCI6MjA3MTc5NzQzMn0.G3HlqGeyLS_39jxbrKtttcsE93A9WvFSEByJow--470'
    );

    async function refreshDatacube() {
      const btn = document.getElementById('refreshBtn');
      const resultDiv = document.getElementById('result');
      
      btn.disabled = true;
      btn.textContent = 'Refreshing...';
      
      resultDiv.className = 'result loading';
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = 'Refreshing analytics datacube...';

      try {
        const { data, error } = await supabase.functions.invoke('auto-refresh-analytics', {
          body: { manual_refresh: true, triggered_at: new Date().toISOString() }
        });

        if (error) {
          throw error;
        }

        resultDiv.className = 'result success';
        resultDiv.innerHTML = `
          <strong>âœ“ Success!</strong><br>
          ${data.message}<br>
          <small>Created ${data.entriesCreated} datacube entries</small>
        `;
        btn.textContent = 'Refresh Complete';
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = 'Refresh Now';
        }, 3000);
      } catch (error) {
        console.error('Error:', error);
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `<strong>Error:</strong> ${error.message || 'Failed to refresh datacube'}`;
        btn.disabled = false;
        btn.textContent = 'Refresh Now';
      }
    }
  </script>
</body>
</html>